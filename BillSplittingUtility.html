<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitting Utility</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Bill Splitting Utility</h1>

    <!-- Section to add participants -->
    <div style="text-align: center; margin-bottom: 20px;">
        <input type="text" id="new-person-input" placeholder="Space Separated Names (e.g. Alice Bob Charlie)"
               style="padding: 5px; width: 300px;" onkeydown="if(event.key === 'Enter') addPersons()"/>
        <button onclick="addPersons()">Add Persons</button>
    </div>

    <!-- Section to add menu items -->
    <div style="text-align: center; margin-bottom: 20px;">
        <input type="text" id="new-menu-item-input" placeholder="Period Separated Items (e.g. Pizza,Burger.Pasta)"
               style="padding: 5px; width: 300px;" onkeydown="if(event.key === 'Enter') addMenuItems()"/>
        <button onclick="addMenuItems()">Add Menu Items</button>
    </div>

    <!-- Dynamic person list -->
    <div id="person-list" class="person-checkboxes">
        <span>No persons added yet.</span>
    </div>

    <!-- Items table -->
    <table>
        <thead>
            <tr>
                <th>Menu Item</th>
                <th>Price</th>
                <th>Split With</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="bill-items">
            <!-- Example Row -->
            <tr>
<!--            todo make this not zoom in on mobile by increasing font size to 16-->
                <td><input type="text" placeholder="Item Name"></td>
                <td><input type="number" step="0.01" placeholder="Price"></td>
                <td class="split-checkboxes"></td>
                <td><button onclick="removeRow(this)">Remove</button></td>
            </tr>
        </tbody>
    </table>
    <h3 style="text-align: center;">Confirm the Subtotal: $<span id="subtotal">0.00</span></h3>
    <button onclick="calculateTotals()">Calculate Totals</button>

    <h2>Payment Summary</h2>
    <table style="width: 50%; margin: 0 auto;">
        <thead>
            <tr>
                <th>Person</th>
                <th>Total Payment</th>
            </tr>
        </thead>
        <tbody id="payment-summary">
        </tbody>
    </table>

    <script>
        // Array to store the list of persons
        const persons = [];

        // Function to add new persons using comma-separated input
        function addPersons() {
            const personInput = document.getElementById('new-person-input');
            const personNames = personInput.value.split(' ').map(name => name.trim()).filter(name => name !== '');

            personNames.forEach(person => {
                if (!persons.includes(person)) {
                    persons.push(person);
                }
            });

            if (persons.length > 0) {
                updatePersonList();
                updateItemRows();
                personInput.value = ''; // Clear input field
            }
        }

        // Function to update the list of persons in the UI
        function updatePersonList() {
            const personList = document.getElementById('person-list');
            personList.innerHTML = ''; // Clear existing list
            persons.forEach(person => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" disabled /> ${person}`;
                personList.appendChild(label);
            });
        }

        function updateSubtotal() {
            const priceInputs = document.querySelectorAll('#bill-items input[type="number"]');
            let subtotal = 0;

            priceInputs.forEach(input => {
                const price = parseFloat(input.value);
                if (!isNaN(price)) {
                    subtotal += price;
                }
            });

            const subtotalElement = document.getElementById('subtotal');
            subtotalElement.textContent = subtotal.toFixed(2);
        }

        // Attach the updateSubtotal function to all price inputs
        function attachSubtotalListeners() {
            const priceInputs = document.querySelectorAll('#bill-items input[type="number"]');
            priceInputs.forEach(input => {
                input.removeEventListener('input', updateSubtotal); // Remove to prevent duplicate listeners
                input.addEventListener('input', updateSubtotal);
            });
        }

        // Function to add menu items dynamically. period+comma separated
        function addMenuItems() {
            const menuInput = document.getElementById('new-menu-item-input');
            // Split menu items by commas or periods and remove empty entries
            const menuItems = menuInput.value.split(/[,.]/).map(item => item.trim()).filter(item => item !== '');

            menuItems.forEach(item => {
                addItemRow(item); // Add each menu item to the table
            });

            menuInput.value = ''; // Clear input field

            // After adding new items, reattach listeners to all inputs
            attachSubtotalListeners();
        }

        function update_tab_index() {
            const rows = document.querySelectorAll('#bill-items tr');
            let tabIndex = 1;

            // First, assign tabindex to the first column of each row
            rows.forEach(row => {
                const firstColumnInput = row.querySelector('td:first-child input');
                if (firstColumnInput) {
                    firstColumnInput.setAttribute('tabindex', tabIndex++);
                }
            });

            // Then, assign tabindex to the second column of each row
            rows.forEach(row => {
                const secondColumnInput = row.querySelector('td:nth-child(2) input');
                if (secondColumnInput) {
                    secondColumnInput.setAttribute('tabindex', tabIndex++);
                }
            });
        }

        // Function to add a new row for menu items
        function addItemRow(itemName = "") {
            const table = document.getElementById('bill-items');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value="${itemName}" placeholder="Item Name"></td>
                <td><input type="number" step="0.01" placeholder="Price"></td>
                <td class="split-checkboxes"></td>
                <td><button onclick="removeRow(this)">Remove</button></td>
            `;
            table.appendChild(row);
            updateItemRows(); // Add checkboxes dynamically for the new row
            update_tab_index(); // Update tabindex after adding the row
        }

        // Function to update checkboxes for each row
        function updateItemRows() {
            const rows = document.querySelectorAll('#bill-items tr .split-checkboxes');
            rows.forEach(cell => {
                cell.innerHTML = ''; // Clear existing checkboxes
                persons.forEach(person => {
                    const label = document.createElement('label');
                    label.innerHTML = `<input type="checkbox" value="${person}" /> ${person}`;
                    cell.appendChild(label);
                });
            });
        }

        // Function to remove a row
        function removeRow(button) {
            const row = button.parentElement.parentElement;
            row.remove();
            update_tab_index(); // Update tabindex after removing the row
        }

        // Function to calculate totals
        function calculateTotals() {
            const rows = document.querySelectorAll('#bill-items tr');
            const totals = {};

            // Initialize totals for each person
            persons.forEach(person => totals[person] = 0);

            rows.forEach(row => {
                const priceInput = row.querySelector('td:nth-child(2) input');
                const checkboxes = row.querySelectorAll('.split-checkboxes input:checked');
                const price = parseFloat(priceInput.value) || 0;

                let involvedPersons = [];
                if (checkboxes.length > 0) {
                    // Add only the selected persons
                    involvedPersons = Array.from(checkboxes).map(checkbox => checkbox.value);
                } else {
                    // If no checkboxes are selected, assume all persons
                    involvedPersons = persons;
                }

                const share = price / involvedPersons.length; // Divide price equally among involved persons
                involvedPersons.forEach(person => {
                    totals[person] += share;
                });
            });

            const summaryTable = document.getElementById('payment-summary');
            summaryTable.innerHTML = ''; // Clear previous results
            Object.keys(totals).forEach(person => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${person}</td>
                    <td>${totals[person].toFixed(2)}</td>
                `;
                summaryTable.appendChild(row);
            });
        }

        // Call the delete button functionality for the first menu item on page load
        // todo this is a hacky way to fix the bug where adding new menu items starts from the second row
        window.onload = function() {
            const firstDeleteButton = document.querySelector('#bill-items tr:first-child button');
            if (firstDeleteButton) {
                firstDeleteButton.click(); // Simulate a click on the delete button
            }
        };
    </script>
</body>
</html>